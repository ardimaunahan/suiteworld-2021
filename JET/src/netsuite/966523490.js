var NS=NS||{};NS.sessionStatusLoader={load:function(){try{this.load()}catch(a){this.errorListener(a)}},init:function(a){this.successListener=a.successListener;this.errorListener=a.errorListener},internal:{serverEndpoint:"/session-status.json",successListener:null,errorListener:null,load:function(){var a=this;NS.jQuery.ajax(this.serverEndpoint,{method:"GET",cache:!1,dataType:"text",headers:{"X-Supress-Cookie-JSessionID":!0},error:function(b,c,d){a.errorListener(d)},success:a.successListener,timeout:3E4})}}};
NS.sessionStatusBus={internal:{normalInterval:1E4,reviveInterval:2E4,key:{local:{wkPrefix:"sm.wk.",sessionStatus:"sm.status",error:"sm.error",schedule:"sm.schedule"},session:{windowId:"sm.windowId"}},workTimer:null,workInterval:null,workTimestamp:null,lastSessionStatus:null,sessionStatusLoader:null,sessionStatusListener:null,errorListener:null,loggingEnabled:!1,log:function(a){if(this.loggingEnabled){var b=new Date,b=b.getHours()+":"+b.getMinutes()+":"+b.getSeconds();console.log(b+" Bus: "+a)}},newWindow:function(a){this.log("New window");
do var b=Math.floor(65536*Math.random()).toString();while(null!=localStorage.getItem(this.constructWk(a)));sessionStorage.setItem(this.key.session.windowId,b);this.registerWindow();setInterval(this.registerWindow.bind(this),this.reviveInterval)},constructWk:function(a){return this.key.local.wkPrefix+a},registerWindow:function(){this.log("Registering, id \x3d "+this.getThisId());localStorage.setItem(this.constructWk(this.getThisId()),(new Date).getTime().toString())},closeWindow:function(){this.log("Close window, id \x3d "+
this.getThisId());localStorage.removeItem(this.constructWk(this.getThisId()));this.sessionStatusListener=function(){};this.errorListener=function(){}},getThisId:function(){return sessionStorage.getItem(this.key.session.windowId)},probableMaster:function(){var a=(new Date).getTime()-(this.reviveInterval+1E4),b=this.getLocalOpenWindows().filter(function(b){return b.timestamp>=a}).sort(function(a,b){return a.id-b.id});if(0<b.length)return b[0].id==this.getThisId();this.log("probable Master: fallback to us: "+
JSON.stringify(this.getLocalOpenWindows()));return!0},getLocalOpenWindows:function(){for(var a=[],b=0;b<localStorage.length;b++){var c=localStorage.key(b);"string"==typeof c&&0==c.indexOf(this.key.local.wkPrefix)&&a.push({id:c.substring(this.key.local.wkPrefix.length),timestamp:localStorage.getItem(c)})}var d=(new Date).getTime();this.log("Windows: "+a.length+": "+a.sort(function(a,b){return a.id-b.id}).map(function(a){return a.id+": "+(d-a.timestamp)/1E3+"s "}));return a},maintenance:function(){try{var a=
(new Date).getTime()-(this.reviveInterval+1E4),b=this;this.getLocalOpenWindows().filter(function(b){return b.timestamp<a}).forEach(function(a){b.log("Maintenance remove window : "+b.constructWk(a.id));localStorage.removeItem(b.constructWk(a.id))})}catch(c){this.log("maintenance error: "+c)}},work:function(){this.log("work");this.onSchedule();this.probableMaster()&&(this.log("MASTER (loading SessionStatus)"),this.sessionStatusLoader(),this.maintenance())},onSchedule:function(a){this.workInterval=void 0==
a?this.slowDown(this.workInterval,this.lastSessionStatus):a;var b=(new Date).getTime()+1E3*this.workInterval;if(a=void 0==a||void 0==this.workTimestamp||this.workTimestamp>b)clearTimeout(this.workTimer),this.workTimer=setTimeout(this.work.bind(this),this.workInterval),this.workTimestamp=b;this.log("onSchedule "+(a?"scheduled: ":"skipped: ")+" "+this.workInterval)},slowDown:function(a,b){a=Math.min(1.15*a,12E4);a=Math.max(a,this.normalInterval);return null!=b&&Math.min(b.at,b.it)<a/1E3+60?this.normalInterval:
a},onSessionStatus:function(a){this.log("receive SessionStatus: "+a);this.lastSessionStatus=JSON.parse(a);this.sessionStatusListener(this.lastSessionStatus)},onError:function(){this.log("receive error");this.errorListener()},localStorageHandler:function(a){if(0==a.key.indexOf("sm."))if(a.key==this.key.local.schedule&&"-1"!=a.newValue)this.onSchedule(a.newValue);else if(a.key==this.key.local.sessionStatus&&"-1"!=a.newValue)this.onSessionStatus(a.newValue);else if(a.key==this.key.local.error&&"-1"!=
a.newValue)this.onError()}},init:function(a){this.sessionStatusLoader=a.sessionStatusLoader;this.sessionStatusListener=a.sessionStatusListener;this.errorListener=a.errorListener;this.newWindow();window.addEventListener("storage",this.localStorageHandler.bind(this));window.addEventListener("unload",this.closeWindow.bind(this))},schedule:function(a){this.log("API: schedule: "+a);localStorage.setItem(this.key.local.schedule,"-1");localStorage.setItem(this.key.local.schedule,a);this.onSchedule(a)},sessionStatusLoadSuccess:function(a){a.t=
(new Date).toLocaleString();this.log("API: load success: "+a);localStorage.setItem(this.key.local.sessionStatus,"-1");localStorage.setItem(this.key.local.sessionStatus,a);this.onSessionStatus(a)},sessionStatusLoadError:function(a){this.log("API: load error: "+a);localStorage.setItem(this.key.local.error,"-1");localStorage.setItem(this.key.local.error,"1");if(this.notifySource)this.onError()}};
NS.sessionStatusBusLegacy={internal:{normalInterval:1E4,interval:2E4,workTimer:null,sessionStatusLoader:null,sessionStatusListener:null,errorListener:null,loggingEnabled:!1,log:function(a){this.loggingEnabled&&console.log("LegacyBus: "+a)},work:function(){this.log("work)");this.sessionStatusLoader()}},init:function(a){this.sessionStatusLoader=a.sessionStatusLoader;this.sessionStatusListener=a.sessionStatusListener;this.errorListener=a.errorListener},schedule:function(a){this.log("API: schedule: "+
a);clearTimeout(this.workTimer);this.workTimer=setTimeout(this.work.bind(this),a)},sessionStatusLoadSuccess:function(a){this.log("API: load success "+this.interval+" "+a);this.workTimer=setTimeout(this.work.bind(this),this.interval);a=JSON.parse(a);this.sessionStatusListener(a)},sessionStatusLoadError:function(a){this.log("API: load error: "+a);this.workTimer=setTimeout(this.work.bind(this),this.interval);this.errorListener()}};NS=NS||{};
NS.sessionStatusUI={onSessionStatus:function(a){null!=a.un&&1==a.un?this.log("Remaining in the previous state"):0!=a.it&&0!=a.at&&this.roleContained(a.rs)?a.it<=this.countdownSince+15?this.stateExpiring(a.it):-1==window.location.href.search(this.skipWrongRoleUrl)&&this.roleMismatch(a.rs)?this.stateWrongRole():this.stateOk(a.ct):this.stateLoggedOut()},onError:function(){this.stateConnectionError()},log:function(a){if(this.loggingEnabled){var b=new Date,b=b.getHours()+":"+b.getMinutes()+":"+b.getSeconds();
console.log(b+" UI: "+a)}},roleContained:function(a){for(var b=a.length,c=0;c<b;c++){var d=a[c];if(d.e===this.entityId&&d.r===this.roleId&&d.c===this.companyId)return!0}return!1},roleMismatch:function(a){for(var b=a.length,c=0;c<b;c++){var d=a[c];if(!0===d.a&&d.e===this.entityId&&d.r===this.roleId&&d.c===this.companyId)return!1}return!0},stopExpiring:function(){clearInterval(this.countdownIntervalHandle);this.countdownIntervalHandle=null},stateLoggedOut:function(){this.log("stateLoggedOut");this.stopExpiring();
this.listeners.onStateLoggedOut({texts:this.translation.loggedOut,url:this.loginUrl})},stateWrongRole:function(){this.log("stateWrongRole");this.stopExpiring();this.listeners.onStateWrongRole({texts:this.translation.wrongRole,url:this.switchRoleUrl+this.id})},stateExpiring:function(a){this.log("stateExpiring");this.stopExpiring();if(0<a){var b=this;if(a<=this.countdownSince){var c={title:this.translation.expiring.title,description:this.translation.expiring.description.replace("?",a),button:this.translation.expiring.button};
this.listeners.onStateExpiring({texts:c,action:function(){b.stateOk();return NS.jQuery.ajax(b.reviveUrl,{method:"GET",dataType:"text",complete:b.refreshHandler,timeout:5E3})}})}this.countdownIntervalHandle=setInterval(function(){b.stateExpiring(--a)},1E3)}else this.stateLoggedOut()},stateOk:function(a){this.log("stateOk");this.stopExpiring();this.listeners.onStateOK({ct:a})},stateConnectionError:function(){this.log("stateConnectionError");this.stopExpiring();this.listeners.onStateConnectionError({texts:this.translation.connectionError})},
listeners:{onStateOK:function(){},onStateConnectionError:function(){},onStateWrongRole:function(){},onStateLoggedOut:function(){},onStateExpiring:function(){}},init:function(a){this.id=a.id;this.entityId=a.entityId;this.roleId=a.roleId;this.companyId=a.companyId;this.refreshHandler=a.refreshHandler;this.translation=a.translation;this.skipWrongRoleUrl="myroles.nl|myrolesdeeplinks.nl";this.reviveUrl="/app/login/secure/ping.nl";this.loginUrl="/pages/login.jsp";this.switchRoleUrl="/app/login/secure/changerole.nl?id\x3d";
this.countdownSince=60;this.countdownIntervalHandle=null;this.loggingEnabled=!1;NS.sessionPopup.init();this.listeners=NS.sessionPopup}};
//# sourceMappingURL=/assets/sessionstatus_init/966523490.map